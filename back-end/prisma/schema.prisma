// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(cuid())
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  username          String           @unique
  email             String           @unique
  verifiedEmail     Boolean
  password          String
  avatarUrl         String
  Status            Boolean          // offline / online
  twoFactor         Boolean

  historyGames1     HistoryGame[]    @relation("user1")
  historyGames2     HistoryGame[]    @relation("user2")
  winnerGames       HistoryGame[]    @relation("winner")

  stats             Stats?
  sentMessages      DirectMessage[]  @relation("SentMessages")
  receivedMessages  DirectMessage[]  @relation("ReceivedMessages")

  rooms             ChatRoom[]       @relation("UserRooms")
  outgoingMessages  RoomMessage[]    @relation("SentMessages")

  memberships       Member[]         @relation("UserMemberships")
  mutedUsers        MutedUsers[]     @relation("MutedUsers")
  banedUsers        BanedUsers[]     @relation("BanedUsers")
  adminsUsers       Admins[]         @relation("Admins")

  // Relation to BlockedUsers as the user who is blocking
  blocking          BlockedUsers[] @relation("Blocking")

  // Relation to BlockedUsers as the user who is blocked
  blocked           BlockedUsers[] @relation("Blocked")
}

model ChatRoom {
  id                String            @id @default(cuid())
  roomName          String
  ownerID           String            // Foreign key to User's id
  isProtected       Boolean
  password          String?
  roomType          String            
  image             String

  // Relation with User - Every chatRoom belongs to one User (owner)
  owner             User              @relation("UserRooms", fields: [ownerID], references: [id])
  messages          RoomMessage[]     @relation("RoomMessages")


  members           Member[]          @relation("RoomMemberships")
  mutedUsers        MutedUsers[]      @relation("RoomMutedUsers") // Relation to MutedUsers
  banedUsers        BanedUsers[]      @relation("RoomBanedUsers") // Relation to MutedUsers
  AdminUsers        Admins[]          @relation("RoomAdmins") // Relation to MutedUsers
}

  // id                Int            @id @default(autoincrement())
model Member {
  userId            String
  chatRoomId        String
  createdAt         DateTime         @default(now())

  // Relation with User and chatRoom
  user              User             @relation("UserMemberships", fields: [userId], references: [id])
  chatRoom          ChatRoom         @relation("RoomMemberships", fields: [chatRoomId], references: [id])

  @@unique([userId, chatRoomId])
}

model MutedUsers {
  id        String    @id @default(cuid())
  userId    String    // Foreign key to User's id
  roomId    String    // Foreign key to ChatRoom's id
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation("MutedUsers",fields: [userId], references: [id])
  chatRoom  ChatRoom  @relation("RoomMutedUsers",fields: [roomId], references: [id])

  @@unique([userId, roomId])
}

model BanedUsers {
  id        String    @id @default(cuid())
  userId    String    // Foreign key to User's id
  roomId    String    // Foreign key to ChatRoom's id
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation("BanedUsers",fields: [userId], references: [id])
  chatRoom  ChatRoom  @relation("RoomBanedUsers",fields: [roomId], references: [id])

  @@unique([userId, roomId])
}


model Admins {
  id        String    @id @default(cuid())
  userId    String    // Foreign key to User's id
  roomId    String    // Foreign key to ChatRoom's id
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation("Admins",fields: [userId], references: [id])
  chatRoom  ChatRoom  @relation("RoomAdmins",fields: [roomId], references: [id])

  @@unique([userId, roomId])
}


model RoomMessage {
  messageId    String      @id @default(cuid())
  senderId     String      // Foreign key to User's id
  roomId       String      // Foreign key to ChatRoom's id
  createdAt    DateTime    @default(now())
  message      String

  // Relations
  sender       User        @relation("SentMessages", fields: [senderId], references: [id])
  room         ChatRoom    @relation("RoomMessages", fields: [roomId], references: [id])
}

model DirectMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  message   String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  readed    Boolean
  senderId  String
  receiverId String
}

model BlockedUsers {
  id                String        @id @default(cuid())
  // Relation to User who is blocking
  blockingUser      User          @relation("Blocking", fields: [blockingId], references: [id])
  blockingId        String
  // Relation to User who is blocked
  blockedUser       User          @relation("Blocked", fields: [blockedId], references: [id])
  blockedId         String
}

model Stats {
  statsId       String      @id @default(cuid())
  wins          Int
  loses         Int
  userId        String      @unique
  User          User        @relation(fields: [userId], references: [id])
}

model HistoryGame {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  userId1       String
  userId2       String
  winnerId      String
  startTimeGame DateTime
  endTimeGame   DateTime
  scoreUser1    Int
  scoreUser2    Int

  // Define the relation with User
  user1        User @relation("user1", fields: [userId1], references: [id])
  user2        User @relation("user2", fields: [userId2], references: [id])
  winner       User @relation("winner", fields: [winnerId], references: [id])
}